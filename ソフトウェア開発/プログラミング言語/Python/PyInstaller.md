---
title: PyInstaller
created: 2025-09-29 14:03:54
updated: 2025-09-29 14:36:28
tags:
  - Python
---

# PyInstaller

## 1. PyInstaller とは

PyInstaller は、Python アプリケーションをスタンドアロンの実行可能ファイル（Windows の `.exe`、macOS の `.app`、Linux の実行ファイルなど）にパッケージ化するためのツールです。これにより、Python インタープリタがインストールされていない環境でも、Python アプリケーションを実行できるようになります。

## 2. 基本的な使い方

もっとも基本的な使い方は、コマンドラインでスクリプトファイルを指定するだけです。

```bash
pyinstaller your_script.py
```

このコマンドを実行すると、`dist` ディレクトリ内に実行可能ファイルが、`build` ディレクトリ内にビルドプロセスの中間ファイルが生成されます。

## 3. よく使うオプション

PyInstaller には、ビルドをカスタマイズするための多くのオプションがあります。

`--onefile`  
すべての依存関係を 1 つの実行可能ファイルにまとめます。配布が容易になりますが、起動に時間がかかる場合があります。

```bash
pyinstaller --onefile your_script.py
```

`--noconsole`  
Windows 環境で、実行時にコンソールウィンドウを表示しないようにします。GUI アプリケーションでよく使用されます。

```bash
pyinstaller --noconsole your_script.py
```

`--name <name>`  
生成される実行可能ファイルの名前を指定します。

```bash
pyinstaller --name MyApp --onefile your_script.py
```

`--add-data <src;dest>` (Windows)  
`--add-data <src:dest>` (Unix/macOS)  
アプリケーションが必要とするデータファイル（画像、設定ファイルなど）を実行可能ファイルに含めます。`src` はソースパス、`dest` は実行可能ファイル内の相対パスです。

```bash
# Windows の例
pyinstaller --add-data "images;images" your_script.py
# Unix/macOS の例
pyinstaller --add-data "images:images" your_script.py
```

`--hidden-import <module_name>`  
PyInstaller が自動的に検出できないモジュールを強制的に含めます。動的インポートや特定のライブラリ（例: `fitz` のような C 拡張を含むもの）で必要になることがあります。

```bash
pyinstaller --hidden-import "some_module" your_script.py
```

`--pathex <path>`  
モジュールを検索する追加のパスを指定します。とくに、プロジェクトが複数のサブディレクトリに分かれている場合に重要です。

## 4. Spec ファイルの役割と編集方法

`pyinstaller` コマンドを実行すると、通常は `your_script.spec` という名前の **spec ファイル**が自動生成されます。このファイルは Python スクリプトであり、PyInstaller のビルド設定を詳細に記述するためのものです。

`pyinstaller your_script.py` の代わりに `pyinstaller your_script.spec` を実行することで、spec ファイルに記述された設定に基づいてビルドが行われます。

spec ファイルを直接編集することで、より複雑な設定（例: 複数のスクリプト、特定のデータファイルの追加、フックの指定など）を行うことができます。

### 主要なブロック

- **`Analysis`**: アプリケーションのソースコードを解析し、依存関係を特定します。
  - `pathex`: Python がモジュールを検索するパスのリスト。プロジェクトのルートディレクトリや、サブディレクトリをモジュールパスとして追加する際に重要です。
  - `binaries`: 実行可能ファイルに含めるバイナリファイル（DLL など）のリスト。
  - `datas`: 実行可能ファイルに含めるデータファイル（画像、設定ファイルなど）のリスト。
  - `hiddenimports`: PyInstaller が自動検出できないモジュールを強制的に含めるリスト。
- **`PYZ`**: Python のバイトコードをアーカイブします。
- **`EXE`**: 実行可能ファイルを生成するための設定。
  - `name`: 実行可能ファイルの名前。
  - `console`: `True` でコンソール表示、`False` で非表示（`--noconsole` オプションに相当）。
  - `onefile`: `True` で単一ファイル、`False` で複数ファイル（`--onefile` オプションに相当）。

## 5. 複数ファイル構成での `pathex` の重要性

`src` ディレクトリ内に `config` や `ui` などのサブディレクトリがあり、それらを `from config.settings import AppSettings` のように `src` を起点とした絶対パス形式でインポートしている場合、PyInstaller はデフォルトではこれらのモジュールを見つけられません。

この問題を解決するためには、spec ファイルの `Analysis` ブロックにある `pathex` に `src` ディレクトリのパスを追加する必要があります。

```python
# spec ファイルの例
import os

a = Analysis(
    ['src/main.py'],
    pathex=[os.path.abspath('src')], # src ディレクトリをモジュール検索パスに追加
    # ... その他の設定 ...
)
```

`os.path.abspath('src')` を使用することで、spec ファイルがどこにあっても `src` ディレクトリへの正しい絶対パスを指定できます。

## 6. トラブルシューティングのヒント

- **`ModuleNotFoundError`**
  - **`pathex` の確認**: 自作モジュールが見つからない場合、spec ファイルの `pathex` に該当するディレクトリが追加されているか確認してください。
  - **`hiddenimports` の追加**: PyInstaller が動的にインポートされるモジュールや、C 拡張を含むモジュールを検出できない場合があります。その際は、`--hidden-import` オプションを使用するか、spec ファイルの `hiddenimports` にモジュール名を追加してください。
- **データファイルが見つからない**
  - 画像、設定ファイル、データベースファイルなどが実行可能ファイルに同梱されていない場合、`--add-data` オプションを使用するか、spec ファイルの `datas` にパスを追加してください。
- **ビルドエラーの詳細**
  - PyInstaller の出力ログを注意深く確認してください。エラーメッセージや警告メッセージが問題解決のヒントになります。

## 7. exe ファイルの容量削減プラクティス

PyInstaller で生成される exe ファイルの容量を削減するためのプラクティスはいくつかございます。

### 7.1. `--onefile` ではなく `--onedir` を検討する

- **`--onefile`**: すべての依存関係を単一の実行ファイルにまとめます。配布は容易ですが、実行時に内部でファイルを解凍するため、起動が遅くなったり、結果的にファイルサイズが大きくなったりする傾向があります。
- **`--onedir`**: 実行ファイルと依存関係をディレクトリにまとめます。個々のファイルサイズは小さくなり、起動も速くなることが多いです。配布はディレクトリごとになります。容量削減が最優先であれば、`--onedir` を試す価値があります。

### 7.2. 不要なモジュールを除外する (`--exclude-module`)

PyInstaller は依存関係を自動的に検出しますが、時には実際には使用されていないモジュールまで含めてしまうことがあります。

- **`--debug=all` でビルドログを確認**: ビルド時に `--debug=all` オプションを付けてログを詳細に確認し、不要と思われるモジュールがバンドルされていないかチェックします。
- **`--exclude-module <module_name>`**: 不要なモジュールが特定できた場合、このオプションを使って明示的に除外します。たとえば、`PyQt` を使っていないのに含まれている場合は `--exclude-module PyQt5` のように指定します。

### 7.3. UPX を活用する

UPX (Ultimate Packer for eXecutables) は、実行ファイルを圧縮するツールです。PyInstaller はデフォルトで UPX を使用しますが、システムに UPX がインストールされていない場合や、特定のバージョンを使いたい場合に設定できます。

- **UPX のインストール**: システムに UPX がインストールされていることを確認してください。
- **`--upx-dir <path_to_upx>`**: UPX の実行ファイルがあるディレクトリを明示的に指定できます。
- **`--noupx` は使用しない**: 容量削減が目的なら、UPX を無効にする `--noupx` オプションは避けるべきです。

### 7.4. `datas` や `binaries` に含めるファイルを厳選する

`--add-data` オプションや `spec` ファイルの `datas` / `binaries` に含めるファイルは、本当にアプリケーションの実行に必要なものだけに絞り込みます。

- 開発中に使用したテストデータ、ドキュメント、不要な画像ファイルなどが誤って含まれていないか確認してください。

### 7.5. `hiddenimports` を最小限にする

`--hidden-import` オプションや `spec` ファイルの `hiddenimports` は、PyInstaller が自動検出できないモジュールを追加するために使いますが、必要以上に多くのモジュールを追加すると容量が増加します。本当に必要なものだけを追加するようにしてください。

### 7.6. Python のバージョン

一般的に、新しい Python のバージョンは古いバージョンよりも最適化が進んでおり、結果的に生成される実行ファイルのサイズが小さくなることがあります。可能であれば、最新の安定版 Python を使用することを検討してください。

### 7.7. 仮想環境をクリーンにする

ビルドに使用する仮想環境には、プロジェクトに必要な最小限のライブラリのみをインストールするようにします。開発中に一時的にインストールしただけのライブラリなどが含まれていると、PyInstaller がそれらを含めてしまう可能性があります。
